# 高级记忆管理与向量索引集成

## 概述

`AdvancedMemoryManagerWithIndex` 是 KnowForge v0.2.0 引入的核心组件，它整合了向量索引和查询缓存功能，为 KnowForge 提供高性能的知识检索解决方案。本文档详细介绍了该组件的设计思路、实现细节及使用方法。

## 功能特点

- **向量索引集成**：利用定制的向量索引结构，显著提高相似性搜索性能
- **查询缓存**：缓存常用查询结果，减少重复计算
- **多级检索回退**：确保即使在部分搜索失败的情况下也能返回合理结果
- **上下文感知检索**：考虑额外上下文信息进行更精准的搜索
- **批量检索优化**：针对批量查询场景的专门优化

## 主要组件

### 1. 向量索引 (`VectorIndex`)

- 支持混合索引类型（HNSW、IVF等）
- 实现高效的向量搜索和相似度计算
- 提供向量增删改查的完整操作集

### 2. 查询缓存 (`QueryCache`)

- 基于LRU算法的查询结果缓存
- 支持基于TTL的自动过期
- 可配置的相似度阈值，允许近似匹配缓存结果

### 3. 高级记忆管理器 (`AdvancedMemoryManagerWithIndex`)

- 整合基础记忆管理功能和向量索引
- 实现智能回退检索策略
- 支持上下文感知的结果排序

## 核心算法

### 向量检索流程

1. **缓存查找**：首先检查查询缓存是否有匹配结果
2. **向量索引搜索**：如无缓存命中，使用向量索引进行快速搜索
3. **多级回退**：
   - 向量索引失败时回退到基础ChromaDB检索
   - 仍无结果时尝试关键词匹配
   - 最后兜底返回全部文档排序结果

### 上下文感知排序

当提供上下文文本时，系统会：
1. 先获取基础检索结果
2. 计算每个结果与上下文的相似度
3. 重新加权基础相似度和上下文相似度
4. 根据综合得分重排序结果

## 性能优化

- **矢量批处理**：批量计算相似度减少计算开销
- **缓存预热**：常用查询自动进入缓存提高命中率
- **懒加载向量**：仅在需要时才加载向量表示
- **阈值自动调整**：根据结果数量动态调整相似度阈值

## 错误处理策略

- **数据库连接错误**：自动重试与无缝降级
- **空结果处理**：多级回退确保总能返回结果
- **向量操作异常**：完善的日志和错误恢复机制

## 使用示例

```python
from src.note_generator.advanced_memory_with_index import AdvancedMemoryManagerWithIndex

# 初始化
memory = AdvancedMemoryManagerWithIndex(
    chroma_db_path="/path/to/db",
    embedding_model="sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2"
)

# 添加知识
doc_id = memory.add_knowledge("人工智能是计算机科学的分支之一，它企图了解智能的实质...")

# 检索知识
results = memory.retrieve_similar("机器学习的基本原理")

# 上下文检索
context_results = memory.retrieve_similar(
    "编程语言", 
    context_texts=["Web开发", "JavaScript"]
)

# 批量检索
batch_results = memory.batch_retrieve_similar(
    ["人工智能", "机器学习", "深度学习"]
)
```

## 调优建议

- **向量维度**：根据数据规模和性能需求选择合适的向量维度
- **索引类型**：小数据集推荐HNSW，大数据集推荐混合索引
- **缓存大小**：根据内存限制和查询模式配置缓存大小
- **相似度阈值**：建议范围为0.6-0.8，视应用场景调整

## 约束与限制

- 依赖高质量的向量表示模型
- 大规模数据集可能需要更复杂的分片策略
- 上下文加权目前使用简单线性组合，可进一步优化

## 未来改进方向

- 实现更高级的上下文感知算法
- 增加分布式索引支持
- 引入自适应缓存策略
- 对极大规模数据集的进一步优化
